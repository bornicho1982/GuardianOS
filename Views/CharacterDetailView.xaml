<UserControl x:Class="GuardianOS.Views.CharacterDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:GuardianOS.Views"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converters="clr-namespace:GuardianOS.Core.Converters"
             xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1400"
             Background="Transparent"
             Loaded="UserControl_Loaded">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <converters:InvertedBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>

        <!-- Equipment Slot Style -->
        <Style x:Key="EquipmentSlotStyle" TargetType="Border">
            <Setter Property="Width" Value="68"/>
            <Setter Property="Height" Value="68"/>
            <Setter Property="Background" Value="#33000000"/>
            <Setter Property="BorderBrush" Value="#44FFFFFF"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Margin" Value="3"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="#FFD700"/>
                    <Setter Property="BorderThickness" Value="2"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Power Badge Style -->
        <Style x:Key="PowerBadgeStyle" TargetType="Border">
            <Setter Property="Background" Value="#DD000000"/>
            <Setter Property="CornerRadius" Value="2"/>
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="VerticalAlignment" Value="Bottom"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="Margin" Value="2"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- Dark Destiny-style background -->
        <Grid.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="#080810" Offset="0"/>
                <GradientStop Color="#12121F" Offset="0.5"/>
                <GradientStop Color="#181830" Offset="1"/>
            </LinearGradientBrush>
        </Grid.Background>

        <!-- Subtle emblem background -->
        <Image Source="{Binding Character.EmblemBackgroundUrl}" 
               Stretch="UniformToFill" Opacity="0.05"/>

        <!-- Header -->
        <Border Height="55" VerticalAlignment="Top" Panel.ZIndex="10">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#CC000000" Offset="0"/>
                    <GradientStop Color="#00000000" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <Grid Margin="30,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Image Source="{Binding Character.EmblemUrl}" Width="44" Height="44" Margin="0,0,15,0"/>
                    <TextBlock Text="{Binding Character.ClassName}" FontSize="22" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                    <TextBlock Text=" · " Foreground="#444" FontSize="22" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Character.RaceName, Mode=OneWay}" Foreground="#888" FontSize="16" VerticalAlignment="Center"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <ToggleButton IsChecked="{Binding Is3DEnabled, Mode=TwoWay}"
                              Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                              ToolTip="Activar/Desactivar visor 3D"
                              Width="40" Height="40" Margin="8,0">
                        <materialDesign:PackIcon Kind="Cube" Width="24" Height="24"/>
                    </ToggleButton>
                    <Button Command="{Binding GoBackCommand}" 
                            Style="{StaticResource MaterialDesignIconButton}" Width="40" Height="40">
                        <materialDesign:PackIcon Kind="Close" Width="28" Height="28" Foreground="White"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Layout -->
        <Grid Margin="25,65,25,25">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- LEFT COLUMN: SUBCLASS + WEAPONS -->
            <StackPanel Grid.Column="0" VerticalAlignment="Center" Width="110">
                <!-- Subclass -->
                <Border Width="65" Height="65" CornerRadius="32" 
                        BorderBrush="#7B2CBF" BorderThickness="3" 
                        Background="#22000000" Margin="0,0,0,20" HorizontalAlignment="Center"
                        ToolTip="{Binding Subclass.Name}">
                    <Grid>
                        <!-- Show icon if subclass loaded -->
                        <Image Source="{Binding Subclass.IconUrl}" Width="40" Height="40"
                               Visibility="{Binding Subclass, Converter={StaticResource NullToVisibility}}"/>
                        <!-- Fallback icon -->
                        <materialDesign:PackIcon Kind="Brightness5" Width="32" Height="32" 
                                                 Foreground="#9D4EDD" HorizontalAlignment="Center" VerticalAlignment="Center"
                                                 Visibility="{Binding Subclass, Converter={StaticResource NullToVisibility}, ConverterParameter=Inverse}"/>
                    </Grid>
                </Border>
                <Border Height="1" Background="#333" Margin="8,0,8,12"/>
                
                <!-- Weapons -->
                <Border Style="{StaticResource EquipmentSlotStyle}" HorizontalAlignment="Center" ToolTip="{Binding KineticWeapon.Name}">
                    <Grid>
                        <Image Source="{Binding KineticWeapon.IconUrl}" Stretch="Uniform" Margin="3"/>
                        <Border Style="{StaticResource PowerBadgeStyle}">
                            <TextBlock Text="{Binding KineticWeapon.PrimaryStatValue}" FontSize="10" FontWeight="Bold" Foreground="#FFD700"/>
                        </Border>
                    </Grid>
                </Border>
                <Border Style="{StaticResource EquipmentSlotStyle}" HorizontalAlignment="Center" ToolTip="{Binding EnergyWeapon.Name}">
                    <Grid>
                        <Image Source="{Binding EnergyWeapon.IconUrl}" Stretch="Uniform" Margin="3"/>
                        <Border Style="{StaticResource PowerBadgeStyle}">
                            <TextBlock Text="{Binding EnergyWeapon.PrimaryStatValue}" FontSize="10" FontWeight="Bold" Foreground="#FFD700"/>
                        </Border>
                    </Grid>
                </Border>
                <Border Style="{StaticResource EquipmentSlotStyle}" HorizontalAlignment="Center" ToolTip="{Binding PowerWeapon.Name}">
                    <Grid>
                        <Image Source="{Binding PowerWeapon.IconUrl}" Stretch="Uniform" Margin="3"/>
                        <Border Style="{StaticResource PowerBadgeStyle}">
                            <TextBlock Text="{Binding PowerWeapon.PrimaryStatValue}" FontSize="10" FontWeight="Bold" Foreground="#FFD700"/>
                        </Border>
                    </Grid>
                </Border>
                
                <!-- Emotes placeholder -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,20,0,0">
                    <Border Width="26" Height="26" Background="#22FFFFFF" CornerRadius="3" Margin="2"/>
                    <Border Width="26" Height="26" Background="#22FFFFFF" CornerRadius="3" Margin="2"/>
                    <Border Width="26" Height="26" Background="#22FFFFFF" CornerRadius="3" Margin="2"/>
                    <Border Width="26" Height="26" Background="#22FFFFFF" CornerRadius="3" Margin="2"/>
                </StackPanel>
            </StackPanel>

            <!-- CENTER COLUMN: 3D VIEWER -->
            <Grid Grid.Column="1" Margin="30,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- WebView2 3D Viewer -->
                <Border CornerRadius="10" ClipToBounds="True" Background="#11FFFFFF"
                        Visibility="{Binding Is3DEnabled, Converter={StaticResource BoolToVisibility}}">
                    <Grid>
                        <wv2:WebView2 x:Name="Viewer3D"
                                      DefaultBackgroundColor="Transparent"/>
                        
                        <!-- Loading Spinner Overlay -->
                        <Border Background="#DD080810" 
                                Visibility="{Binding IsWebViewLoading, Converter={StaticResource BoolToVisibility}}">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <ProgressBar IsIndeterminate="True" 
                                             Style="{StaticResource MaterialDesignCircularProgressBar}"
                                             Width="48" Height="48" Foreground="#7B2CBF"/>
                                <TextBlock Text="Cargando visor 3D..." Foreground="#888" 
                                           Margin="0,12,0,0" HorizontalAlignment="Center" FontSize="12"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>
                
                <!-- Static Image Fallback (when 3D disabled) -->
                <Border CornerRadius="10" ClipToBounds="True" Background="#22FFFFFF"
                        Visibility="{Binding Is3DEnabled, Converter={StaticResource InverseBoolToVisibility}}">
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                        <materialDesign:PackIcon Kind="AccountBox" Width="120" Height="120" Foreground="#333"/>
                        <TextBlock Text="Visor 3D Desactivado" Foreground="#666" 
                                   Margin="0,12,0,0" HorizontalAlignment="Center" FontSize="14"/>
                        <TextBlock Text="Activa el modo 3D en la cabecera" Foreground="#444" 
                                   HorizontalAlignment="Center" FontSize="11"/>
                    </StackPanel>
                </Border>

                <!-- Guardian Title -->
                <Border Grid.Row="1" Background="#7B2CBF" CornerRadius="4" 
                        Padding="25,8" HorizontalAlignment="Center" Margin="0,12,0,0">
                    <TextBlock Text="G U A R D I A N" FontSize="13" FontWeight="Bold" Foreground="White"/>
                </Border>
            </Grid>

            <!-- RIGHT COLUMN: POWER + STATS + ARMOR -->
            <StackPanel Grid.Column="2" VerticalAlignment="Top" Width="180">
                <!-- POWER -->
                <StackPanel HorizontalAlignment="Center" Margin="0,15,0,20">
                    <TextBlock Text="POWER" FontSize="9" FontWeight="Bold" Foreground="#666" HorizontalAlignment="Center"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="✦" FontSize="22" Foreground="#FFD700" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding Character.Light}" FontSize="32" FontWeight="Bold" Foreground="#FFD700"/>
                    </StackPanel>
                </StackPanel>

                <!-- Stats Grid -->
                <Border Background="#11FFFFFF" CornerRadius="6" Padding="10" Margin="0,0,0,15">
                    <UniformGrid Rows="2" Columns="3">
                        <StackPanel Margin="3">
                            <TextBlock Text="{Binding Character.Mobility}" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            <ProgressBar Value="{Binding Character.Mobility, Mode=OneWay}" Height="3" Background="#333" Foreground="#3498DB" BorderThickness="0" Margin="0,2"/>
                            <TextBlock Text="MOB" FontSize="7" Foreground="#777" HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Margin="3">
                            <TextBlock Text="{Binding Character.Resilience}" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            <ProgressBar Value="{Binding Character.Resilience, Mode=OneWay}" Height="3" Background="#333" Foreground="#E74C3C" BorderThickness="0" Margin="0,2"/>
                            <TextBlock Text="RES" FontSize="7" Foreground="#777" HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Margin="3">
                            <TextBlock Text="{Binding Character.Recovery}" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            <ProgressBar Value="{Binding Character.Recovery, Mode=OneWay}" Height="3" Background="#333" Foreground="#2ECC71" BorderThickness="0" Margin="0,2"/>
                            <TextBlock Text="REC" FontSize="7" Foreground="#777" HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Margin="3">
                            <TextBlock Text="{Binding Character.Discipline}" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            <ProgressBar Value="{Binding Character.Discipline, Mode=OneWay}" Height="3" Background="#333" Foreground="#9B59B6" BorderThickness="0" Margin="0,2"/>
                            <TextBlock Text="DIS" FontSize="7" Foreground="#777" HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Margin="3">
                            <TextBlock Text="{Binding Character.Intellect}" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            <ProgressBar Value="{Binding Character.Intellect, Mode=OneWay}" Height="3" Background="#333" Foreground="#F1C40F" BorderThickness="0" Margin="0,2"/>
                            <TextBlock Text="INT" FontSize="7" Foreground="#777" HorizontalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Margin="3">
                            <TextBlock Text="{Binding Character.Strength}" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            <ProgressBar Value="{Binding Character.Strength, Mode=OneWay}" Height="3" Background="#333" Foreground="#E67E22" BorderThickness="0" Margin="0,2"/>
                            <TextBlock Text="STR" FontSize="7" Foreground="#777" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </UniformGrid>
                </Border>

                <Border Height="1" Background="#333" Margin="8,0,8,12"/>
                <TextBlock Text="ARMADURA" FontSize="9" FontWeight="Bold" Foreground="#666" HorizontalAlignment="Center" Margin="0,0,0,8"/>

                <!-- Armor Grid -->
                <UniformGrid Columns="2" HorizontalAlignment="Center">
                    <Border Style="{StaticResource EquipmentSlotStyle}" ToolTip="{Binding Helmet.Name}">
                        <Grid>
                            <Image Source="{Binding Helmet.IconUrl}" Stretch="Uniform" Margin="3"/>
                            <Border Style="{StaticResource PowerBadgeStyle}">
                                <TextBlock Text="{Binding Helmet.PrimaryStatValue}" FontSize="9" FontWeight="Bold" Foreground="#FFD700"/>
                            </Border>
                        </Grid>
                    </Border>
                    <Border Style="{StaticResource EquipmentSlotStyle}" ToolTip="{Binding Gauntlets.Name}">
                        <Grid>
                            <Image Source="{Binding Gauntlets.IconUrl}" Stretch="Uniform" Margin="3"/>
                            <Border Style="{StaticResource PowerBadgeStyle}">
                                <TextBlock Text="{Binding Gauntlets.PrimaryStatValue}" FontSize="9" FontWeight="Bold" Foreground="#FFD700"/>
                            </Border>
                        </Grid>
                    </Border>
                    <Border Style="{StaticResource EquipmentSlotStyle}" ToolTip="{Binding ChestArmor.Name}">
                        <Grid>
                            <Image Source="{Binding ChestArmor.IconUrl}" Stretch="Uniform" Margin="3"/>
                            <Border Style="{StaticResource PowerBadgeStyle}">
                                <TextBlock Text="{Binding ChestArmor.PrimaryStatValue}" FontSize="9" FontWeight="Bold" Foreground="#FFD700"/>
                            </Border>
                        </Grid>
                    </Border>
                    <Border Style="{StaticResource EquipmentSlotStyle}" ToolTip="{Binding LegArmor.Name}">
                        <Grid>
                            <Image Source="{Binding LegArmor.IconUrl}" Stretch="Uniform" Margin="3"/>
                            <Border Style="{StaticResource PowerBadgeStyle}">
                                <TextBlock Text="{Binding LegArmor.PrimaryStatValue}" FontSize="9" FontWeight="Bold" Foreground="#FFD700"/>
                            </Border>
                        </Grid>
                    </Border>
                </UniformGrid>
                <Border Style="{StaticResource EquipmentSlotStyle}" HorizontalAlignment="Center" Margin="0,3,0,0" ToolTip="{Binding ClassItem.Name}">
                    <Grid>
                        <Image Source="{Binding ClassItem.IconUrl}" Stretch="Uniform" Margin="3"/>
                        <Border Style="{StaticResource PowerBadgeStyle}">
                            <TextBlock Text="{Binding ClassItem.PrimaryStatValue}" FontSize="9" FontWeight="Bold" Foreground="#FFD700"/>
                        </Border>
                    </Grid>
                </Border>
            </StackPanel>
        </Grid>

        <!-- Loading Overlay -->
        <Grid Background="#EE080810" Visibility="{Binding IsLoadingEquipment, Converter={StaticResource BoolToVisibility}, FallbackValue=Collapsed}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="180" Height="3" Foreground="#FFD700"/>
                <TextBlock Text="Cargando equipamiento..." Foreground="White" Margin="0,12,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
