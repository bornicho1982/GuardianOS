<!DOCTYPE html>
<html>

<head>
    <title>Test FBX Viewer</title>
    <style>
        body {
            margin: 0;
            background: #1a1a2e;
        }

        canvas {
            display: block;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial;
        }
    </style>
</head>

<body>
    <div id="info">Loading FBX... Rotate with mouse, zoom with scroll</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>

    <script>
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        // Camera - perspective with good FOV
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1, 0);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
        backLight.position.set(-5, 5, -5);
        scene.add(backLight);

        // Grid helper for reference
        const gridHelper = new THREE.GridHelper(10, 10);
        scene.add(gridHelper);

        // Axes helper
        const axesHelper = new THREE.AxesHelper(2);
        scene.add(axesHelper);

        // Load FBX
        const loader = new THREE.FBXLoader();
        loader.load(
            'http://localhost:5050/api/fbx/1043E180/1043E180.fbx',
            function (fbx) {
                // Log info
                const box = new THREE.Box3().setFromObject(fbx);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());

                console.log('FBX Loaded!');
                console.log('Size:', size);
                console.log('Center:', center);

                document.getElementById('info').innerHTML =
                    `FBX Loaded! Size: X=${size.x.toFixed(2)} Y=${size.y.toFixed(2)} Z=${size.z.toFixed(2)}<br>
                     Rotate with mouse, zoom with scroll wheel`;

                // Center the model
                fbx.position.set(-center.x, -center.y + size.y / 2, -center.z);

                // Apply simple material to all meshes
                fbx.traverse(child => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshStandardMaterial({
                            color: 0x888888,
                            metalness: 0.5,
                            roughness: 0.5,
                            side: THREE.DoubleSide
                        });
                    }
                });

                scene.add(fbx);

                // Adjust camera to fit model
                const maxDim = Math.max(size.x, size.y, size.z);
                camera.position.set(maxDim * 1.5, size.y, maxDim * 1.5);
                controls.target.set(0, size.y / 2, 0);
                controls.update();
            },
            function (progress) {
                if (progress.total > 0) {
                    const pct = Math.round(progress.loaded / progress.total * 100);
                    document.getElementById('info').innerHTML = `Loading: ${pct}%`;
                }
            },
            function (error) {
                console.error('Error loading FBX:', error);
                document.getElementById('info').innerHTML = 'Error loading FBX: ' + error.message;
            }
        );

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>