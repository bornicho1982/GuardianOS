<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="using:Traveler.Core.Models"
             xmlns:asyncImageLoader="using:AsyncImageLoader"
             xmlns:converters="using:Traveler.Desktop.Converters"
             x:Class="Traveler.Desktop.Controls.ItemControl"
             x:DataType="models:InventoryItem"
             Width="50" Height="64">

    <UserControl.Resources>
        <converters:BungieUrlConverter x:Key="BungieUrlConverter"/>
        <converters:MasterworkBorderConverter x:Key="MasterworkBorderConverter"/>
        <converters:TierBackgroundConverter x:Key="TierBackgroundConverter"/>
    </UserControl.Resources>

    <!-- Main Container: Icon (50px) + Badge (14px - 1px overlap) = 63px -->
    <!-- Grid structure mimics DIM's layering -->
    <Grid RowDefinitions="50,14">
        
        <!-- ROW 0: Item Icon (50x50) -->
        <Border Grid.Row="0"
                Width="50" Height="50"
                CornerRadius="0"
                ClipToBounds="True"
                BorderThickness="1"
                BorderBrush="{Binding IsMasterwork, Converter={StaticResource MasterworkBorderConverter}}"
                Background="{Binding TierType, Converter={StaticResource TierBackgroundConverter}}">
            
            <Grid>
                <!-- Layer 1: Item Icon Image (Base) -->
                <asyncImageLoader:AdvancedImage 
                    Source="{Binding IconUrl}" 
                    Stretch="UniformToFill"/>
                
                <!-- Layer 2: Masterwork Overlay Image (DIM style) -->
                <!-- Bungie: masterwork-overlay.png. Needs reduced opacity ~60% -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding MasterworkGlowUrl, Converter={StaticResource BungieUrlConverter}}"
                    Stretch="Fill"
                    Opacity="0.6"
                    IsVisible="{Binding MasterworkGlowUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                
                <!-- Layer 3: Watermark Shadow Layer (Generic) -->
                <!-- Bungie: watermark-layer.png -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding WatermarkLayerUrl}"
                    Stretch="Fill"
                    Opacity="0.8"/>
                
                <!-- Layer 4: Tier Pips Overlay (DIM style) -->
                <!-- Bungie: inventory-item-tier3.png etc -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding TierPipsUrl, Converter={StaticResource BungieUrlConverter}}"
                    Stretch="Fill"
                    IsVisible="{Binding TierPipsUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                <!-- Layer 5: Season/Watermark Icon (Specific) -->
                <!-- Usually aligned with border -->
                <asyncImageLoader:AdvancedImage 
                    Source="{Binding WatermarkIconUrl, Converter={StaticResource BungieUrlConverter}}" 
                    Stretch="Uniform" 
                    Opacity="0.9"
                    Width="50" Height="50"
                    IsVisible="{Binding WatermarkIconUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                
                <!-- Layer 6: Featured Flag (Top-Left) -->
                <!-- Bungie: featured-flag.png -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding FeaturedFlagUrl, Converter={StaticResource BungieUrlConverter}}"
                    Stretch="Uniform"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    IsVisible="{Binding IsFeatured}"/>

                <!-- Layer 7: Weapon Advantage / Archetype Icon (Top-Right) -->
                <!-- 11px with #222 background -->
                <Border Width="11" Height="11"
                        CornerRadius="1.5"
                        Background="#222222"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="0,2,2,0"
                        ClipToBounds="True"
                        IsVisible="{Binding ArchetypeIcon, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <asyncImageLoader:AdvancedImage 
                        Source="{Binding ArchetypeIcon, Converter={StaticResource BungieUrlConverter}}" 
                        Stretch="Uniform"
                        Width="9" Height="9"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"/>
                </Border>
                
                <!-- Layer 8: Icons Tray (bottom-right, above badge line) -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Bottom"
                            Margin="0,0,3,2">
                    
                    <!-- Masterwork Level Indicator (green number) -->
                    <Border Background="#1a1a1a"
                            CornerRadius="2"
                            Padding="2,0"
                            Margin="0,0,2,0"
                            IsVisible="{Binding IsMasterwork}">
                        <TextBlock Text="{Binding MasterworkLevel}" 
                                   FontSize="8" 
                                   FontWeight="Bold"
                                   Foreground="#29f36a"/>
                    </Border>
                    
                    <!-- Lock Icon -->
                    <TextBlock Text="ðŸ”’" 
                               FontSize="9"
                               Foreground="#29f36a"
                               IsVisible="{Binding IsLocked}"
                               Margin="0,0,0,0">
                        <TextBlock.Effect>
                            <DropShadowEffect BlurRadius="2" Color="Black" OffsetX="0" OffsetY="0" Opacity="0.8"/>
                        </TextBlock.Effect>
                    </TextBlock>
                </StackPanel>
                
                <!-- Layer 9: Deepsight Resonance Border -->
                <Border BorderBrush="#d25336"
                        BorderThickness="2"
                        IsVisible="{Binding HasDeepsight}"/>
            </Grid>
        </Border>
        
        <!-- ROW 1: Badge Bar (14px) -->
        <Border Grid.Row="1"
                Height="14"
                Margin="0,-1,0,0"
                Padding="2,0"
                ClipToBounds="True">
            
            <!-- Badge Background -->
            <Border.Background>
                <MultiBinding Converter="{x:Static converters:BadgeBackgroundConverter.Instance}">
                    <Binding Path="IsMasterwork"/>
                    <Binding Path="TierType"/>
                </MultiBinding>
            </Border.Background>
            
            <Grid ColumnDefinitions="Auto,*">
                
                <!-- Element Icon (left side) using Bungie API -->
                <asyncImageLoader:AdvancedImage 
                    Grid.Column="0"
                    Source="{Binding DamageTypeIcon, Converter={StaticResource BungieUrlConverter}}" 
                    Width="10" Height="10"
                    VerticalAlignment="Center"
                    Margin="0,0,2,0"
                    IsVisible="{Binding !HideElementIcon}"/>
                
                <!-- Power Level (right side) -->
                <TextBlock Grid.Column="1"
                           Text="{Binding PowerLevel}" 
                           FontSize="10" 
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Right"
                           VerticalAlignment="Center">
                    <TextBlock.Effect>
                        <DropShadowEffect BlurRadius="1" Color="Black" OffsetX="0" OffsetY="0" Opacity="0.8"/>
                    </TextBlock.Effect>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</UserControl>
