<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="using:Traveler.Core.Models"
             xmlns:asyncImageLoader="using:AsyncImageLoader"
             xmlns:converters="using:Traveler.Desktop.Converters"
             x:Class="Traveler.Desktop.Controls.ItemControl"
             x:DataType="models:InventoryItem"
             Width="50" Height="64">

    <UserControl.Resources>
        <converters:BungieUrlConverter x:Key="BungieUrlConverter"/>
        <converters:MasterworkBorderConverter x:Key="MasterworkBorderConverter"/>
        <converters:TierBackgroundConverter x:Key="TierBackgroundConverter"/>
        <converters:ItemBorderColorConverter x:Key="ItemBorderColorConverter"/>
    </UserControl.Resources>

    <!-- Main Container: 64x76 (DIM Desktop Standard) -->
    <Grid RowDefinitions="*,16" Width="64" Height="76" UseLayoutRounding="True">
        
        <!-- ROW 0: Item Image and Overlays -->
        <Border Grid.Row="0"
                CornerRadius="0"
                ClipToBounds="True"
                BorderThickness="2">
            
            <Border.BorderBrush>
                 <MultiBinding Converter="{x:Static converters:ItemBorderColorConverter.Instance}">
                    <Binding Path="IsMasterwork"/>
                    <Binding Path="HasDeepsight"/>
                    <Binding Path="IsExotic"/>
                </MultiBinding>
            </Border.BorderBrush>

            <Grid>
                <!-- Layer 1: Item Icon Image (Base) -->
                <asyncImageLoader:AdvancedImage 
                    Source="{Binding IconUrl}" 
                    Stretch="UniformToFill"/>
                
                <!-- Layer 2: Masterwork Overlay Image -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding MasterworkGlowUrl, Converter={StaticResource BungieUrlConverter}}"
                    Stretch="Fill"
                    Opacity="0.6"
                    IsVisible="{Binding IsMasterwork}"/>
                
                <!-- Layer 3: Watermark Shadow Layer -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding WatermarkLayerUrl}"
                    Stretch="Fill"
                    Opacity="0.8"/>
                
                <!-- Layer 4: Tier Pips Overlay -->
                <!-- Pips are on the left side of the image -->
                 <asyncImageLoader:AdvancedImage
                    Source="{Binding TierPipsUrl, Converter={StaticResource BungieUrlConverter}}"
                    Stretch="Fill"
                    HorizontalAlignment="Left"
                    IsVisible="{Binding TierPipsUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                <!-- Layer 5: Season/Watermark Icon (Top Left) -->
                <asyncImageLoader:AdvancedImage 
                    Source="{Binding WatermarkIconUrl, Converter={StaticResource BungieUrlConverter}}" 
                    Stretch="Uniform" 
                    Opacity="0.9"
                    Width="16" Height="16"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Margin="2"
                    IsVisible="{Binding WatermarkIconUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                <!-- Layer 6: Featured Flag (Top-Left, behind watermark?) -->
                <asyncImageLoader:AdvancedImage
                    Source="{Binding FeaturedFlagUrl, Converter={StaticResource BungieUrlConverter}}"
                    Stretch="Uniform"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Width="32" Height="32"
                    IsVisible="{Binding IsFeatured}"/>

                <!-- Layer 7: Weapon Perks (Socket Icons) at Bottom -->
                <ItemsControl ItemsSource="{Binding SocketIcons}" 
                              HorizontalAlignment="Center" 
                              VerticalAlignment="Bottom" 
                              Margin="0,0,0,2">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="1"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="14" Height="14" CornerRadius="7" Background="#33000000" BorderBrush="White" BorderThickness="0.5" ClipToBounds="True">
                                <asyncImageLoader:AdvancedImage Source="{Binding ., Converter={StaticResource BungieUrlConverter}}" Stretch="Uniform" />
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Layer 8: Archetype Icon (Top Right) -->
                <Border Width="14" Height="14"
                        CornerRadius="2"
                        Background="#CC000000"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="0,2,2,0"
                        IsVisible="{Binding ArchetypeIcon, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <asyncImageLoader:AdvancedImage 
                        Source="{Binding ArchetypeIcon, Converter={StaticResource BungieUrlConverter}}" 
                        Stretch="Uniform"
                        Width="12" Height="12"/>
                </Border>
                
                <!-- Layer 9: Equipped Indicator (Triangle or Border) -->
                 <Border BorderBrush="#FFFFFFFF" BorderThickness="2" IsVisible="{Binding IsEquipped}" />

            </Grid>
        </Border>
        
        <!-- ROW 1: Footer Bar -->
        <Grid Grid.Row="1" Background="#CC000000"> <!-- Dark semi-transparent background -->
             <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" /> <!-- Element -->
                <ColumnDefinition Width="*" />    <!-- Power -->
            </Grid.ColumnDefinitions>

            <!-- Element Icon -->
            <asyncImageLoader:AdvancedImage 
                Grid.Column="0"
                Source="{Binding DamageTypeIcon, Converter={StaticResource BungieUrlConverter}}" 
                Width="12" Height="12"
                Margin="4,0,0,0"
                VerticalAlignment="Center"
                IsVisible="{Binding !HideElementIcon}"/>

            <!-- Power Level -->
            <TextBlock Grid.Column="1"
                       Text="{Binding PowerLevel}" 
                       FontSize="11" 
                       FontWeight="Bold"
                       Foreground="#F5F5F5"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Center"
                       Margin="0,0,4,0"/>
        </Grid>
    </Grid>
</UserControl>
